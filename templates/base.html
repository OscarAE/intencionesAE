<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title if title else "Intenciones" }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  </head>
  <body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Parroquia</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        {% if session.get('role') == 'admin' %}
          <li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>
        {% endif %}
        {% if session.get('role') in ['funcionario','admin'] %}
          <li class="nav-item"><a class="nav-link" href="/funcionario">Funcionario</a></li>
        {% endif %}
        </ul>
        <div class="d-flex">
          {% if session.get('username') %}
            <span class="me-2">Hola, {{ session.username }}</span>
            <a class="btn btn-outline-secondary btn-sm" href="/logout">Salir</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>
  <div class="container">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-warning">
          <ul class="mb-0">{% for m in messages %}<li>{{ m }}</li>{% endfor %}</ul>
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>
    <script>
(function(){
  const input = document.getElementById('hora_input');
  if (!input) return;

  // helper: set caret position
  function setCaret(pos) {
    try { input.setSelectionRange(pos, pos); }
    catch(e){ /* algunos navegadores pueden fallar silenciosamente */ }
  }

  input.addEventListener('input', function(e){
    // keep only digits
    let digits = this.value.replace(/\D/g, '');
    if (digits.length > 4) digits = digits.slice(0,4);

    // build display value with colon after 2 digits
    let display = digits;
    if (digits.length > 2) display = digits.slice(0,2) + ':' + digits.slice(2);
    // preserve previous length to decide caret behaviour
    const prevLen = this.value.length;
    this.value = display;

    // move caret to end (so the cursor always moves right while typing)
    // small timeout to ensure DOM updated
    setTimeout(() => setCaret(this.value.length), 0);
  });

  // handle keydown for Backspace when colon is present
  input.addEventListener('keydown', function(e){
    const selStart = this.selectionStart;
    const selEnd = this.selectionEnd;

    // if backspace and caret is just after colon, move caret back one and remove digit before colon on next input
    if (e.key === 'Backspace' && selStart === selEnd) {
      if (selStart === 3 && this.value.charAt(2) === ':') {
        // caret is after the colon (position 3)
        // prevent default and set caret to before colon (position 2) so deleting behaves naturally
        e.preventDefault();
        setCaret(2);
        // simulate deletion of previous digit by removing last digit before colon
        const digits = this.value.replace(/\D/g,'').slice(0, -1);
        let newVal = digits;
        if (digits.length > 2) newVal = digits.slice(0,2) + ':' + digits.slice(2);
        setTimeout(()=> { this.value = newVal; setCaret(this.value.length); }, 0);
      }
    }
  });

  // optional: prevent non-digit keys except control (allow navigation keys)
  input.addEventListener('keypress', function(e){
    if (e.ctrlKey || e.metaKey || e.altKey) return;
    const key = e.key;
    if (!/^\d$/.test(key)) {
      // allow Enter, Tab, Arrow keys etc.
      if (key.length === 1) e.preventDefault();
    }
  });

  // handle paste: accept only numeric characters and reformat
  input.addEventListener('paste', function(e){
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    const digits = paste.replace(/\D/g,'').slice(0,4);
    let display = digits;
    if (digits.length > 2) display = digits.slice(0,2) + ':' + digits.slice(2);
    this.value = display;
    setTimeout(()=> setCaret(this.value.length), 0);
  });

})();
</script>
<script>
(function(){
  const input = document.getElementById('hora_input');
  if (!input) return;

  input.addEventListener('input', function(e){
    let v = this.value.replace(/\D/g,'');   // solo números

    if(v.length > 4) v = v.slice(0,4);

    // Construir formato HH:MM
    if(v.length >= 3){
        v = v.slice(0,2) + ":" + v.slice(2);
    }

    this.value = v;

    // Mover el cursor siempre al final
    setTimeout(() => {
       this.selectionStart = this.selectionEnd = this.value.length;
    }, 0);
  });

})();
</script>
    <script>
(function(){
  const input = document.getElementById('hora_input');
  if (!input) return;

  input.addEventListener('input', function(e){
    let v = this.value.replace(/\D/g, ''); // solo dígitos

    // limitar a 4 dígitos HHMM
    if (v.length > 4) v = v.slice(0,4);

    // insertar ":"
    if (v.length >= 3) {
      v = v.slice(0,2) + ":" + v.slice(2);
    }

    this.value = v;

    // mover caret al final
    setTimeout(() => {
        this.selectionStart = this.selectionEnd = this.value.length;
    }, 0);
  });

  // Validación real al perder el foco
  input.addEventListener('blur', function(){
    const val = this.value;
    if (!val || val.length !== 5 || val.indexOf(":") !== 2) return;

    let [hh, mm] = val.split(":");
    hh = parseInt(hh, 10);
    mm = parseInt(mm, 10);

    // Validación HH
    if (isNaN(hh) || hh < 0 || hh > 23) {
        alert("La hora debe estar entre 00 y 23.");
        this.value = "";
        this.focus();
        return;
    }

    // Validación MM
    if (isNaN(mm) || mm < 0 || mm > 59) {
        alert("Los minutos deben estar entre 00 y 59.");
        this.value = "";
        this.focus();
        return;
    }

    // Reconstruir siempre en formato HH:MM con ceros
    const hh_fix = (hh < 10 ? "0" : "") + hh;
    const mm_fix = (mm < 10 ? "0" : "") + mm;

    this.value = `${hh_fix}:${mm_fix}`;
  });

})();
</script>
<script>
function soloMayusculasComasPuntos(input) {
    let valor = input.value;

    // Convertir todo a MAYÚSCULAS (incluye ñ → Ñ)
    valor = valor.toUpperCase();

    // Mantener solo: A-Z, Ñ, espacio, coma y punto
    valor = valor.replace(/[^A-ZÑ .,]/g, '');

    input.value = valor;
}
</script>
</body>
</html>
