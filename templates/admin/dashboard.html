{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">Panel de Administración</h2>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">

    <!-- Usuarios -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-people-fill display-4 text-primary mb-3"></i>
                <h4 class="card-title">Usuarios</h4>
                <p class="text-muted">Administrar los usuarios y sus permisos.</p>
                <a href="/admin?section=crear_usuario" class="btn btn-primary btn-sm">Crear</a>
                <a href="/admin?section=usuarios" class="btn btn-outline-secondary btn-sm">Consultar</a>
            </div>
        </div>
    </div>

    <!-- Misas -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-calendar-check display-4 text-success mb-3"></i>
                <h4 class="card-title">Misas</h4>
                <p class="text-muted">Gestión de misas por fecha y hora.</p>
                <a href="/admin?section=crear_misa" class="btn btn-primary btn-sm">Crear</a>
                <a href="/admin?section=misas" class="btn btn-outline-secondary btn-sm">Consultar</a>
            </div>
        </div>
    </div>

    <!-- Categorías -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-tags-fill display-4 text-warning mb-3"></i>
                <h4 class="card-title">Categorías</h4>
                <p class="text-muted">Clasificación de intenciones.</p>
                <a href="/admin?section=crear_categoria" class="btn btn-primary btn-sm">Crear</a>
                <a href="/admin?section=categorias" class="btn btn-outline-secondary btn-sm">Consultar</a>
            </div>
        </div>
    </div>

    <!-- Frases -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-chat-left-text-fill display-4 text-info mb-3"></i>
                <h4 class="card-title">Frases Base</h4>
                <p class="text-muted">Frases usadas en intenciones.</p>
                <a href="/admin?section=crear_frase" class="btn btn-primary btn-sm">Crear</a>
                <a href="/admin?section=frases" class="btn btn-outline-secondary btn-sm">Consultar</a>
            </div>
        </div>
    </div>

    <!-- Configuración -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-gear-fill display-4 text-secondary mb-3"></i>
                <h4 class="card-title">Configuración</h4>
                <p class="text-muted">Ajustes y mensajes globales.</p>
                <a href="/admin?section=config" class="btn btn-outline-secondary btn-sm">Abrir</a>
            </div>
        </div>
    </div>

    <!-- Exportaciones -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-download display-4 text-dark mb-3"></i>
                <h4 class="card-title">Exportar Intenciones</h4>
                <p class="text-muted">Descargar intenciones en CSV por rango de fechas.</p>
                <a href="/admin?section=export" class="btn btn-outline-secondary btn-sm">Exportar CSV</a>
            </div>
        </div>
    </div>

    <!-- Eliminación -->
    <div class="col">
        <div class="card shadow-sm border-0 h-100 text-center">
            <div class="card-body">
                <i class="bi bi-trash-fill display-4 text-danger mb-3"></i>
                <h4 class="card-title">Eliminación de Datos</h4>
                <p class="text-muted">Eliminar intenciones antiguas.</p>
                <a href="/admin?section=delete" class="btn btn-danger btn-sm">Eliminar</a>
            </div>
        </div>
    </div>

</div>


</div>
<hr class="my-4">

{% if section == "usuarios" %}
<h3 class="mb-3">Usuarios del Sistema</h3>

<table class="table table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
        </tr>
    </thead>

    <tbody>
    {% for u in users %}
        <tr>

            <!-- Ícono según tipo -->
            <td>
                {% if u.role == 'admin' %}
                    <i class="bi bi-shield-lock-fill text-primary me-2"></i>
                {% else %}
                    <i class="bi bi-person-fill text-secondary me-2"></i>
                {% endif %}
                {{ u.username }}
            </td>

            <!-- Rol -->
            <td>
                {% if u.role == 'admin' %}
                    <span class="badge bg-primary">Administrador</span>
                {% else %}
                    <span class="badge bg-secondary">Funcionario</span>
                {% endif %}
            </td>

            <!-- Estado -->
            <td>
                {% if u.active %}
                    <span class="badge bg-success">Activo</span>
                {% else %}
                    <span class="badge bg-danger">Inactivo</span>
                {% endif %}
            </td>

            <!-- Acciones -->
            <td class="text-center">

                <!-- Botón Activar / Inactivar -->
                <a href="/admin/users/toggle/{{ u.id }}"
                   class="btn btn-sm btn-warning me-1">
                    Activar / Inactivar
                </a>

                <!-- SOLO funcionarios pueden eliminarse -->
                {% if u.role != 'admin' %}
                    <a href="/admin/users/delete/{{ u.id }}"
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('¿Eliminar este usuario?')">
                        Eliminar
                    </a>
                {% else %}
                    <!-- Icono de candado si es admin -->
                    <i class="bi bi-lock-fill text-muted" title="No se puede eliminar un administrador"></i>
                {% endif %}

            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% endif %}


{% if section == "crear_usuario" %}
<h3>Crear Usuario</h3>
<form method="post" action="/admin/users/create" class="row g-3 mb-4">
    <div class="col-md-4">
        <label>Usuario</label>
        <input name="username" class="form-control" oninput="soloMayusculasComasPuntos(this)" required>
    </div>
    <div class="col-md-4">
        <label>Contraseña</label>
        <input name="password" type="password" class="form-control" required>
    </div>
    <div class="col-md-4">
        <label>Rol</label>
        <select name="role" class="form-select">
            <option value="funcionario">Funcionario</option>
            <option value="admin">Administrador</option>
        </select>
    </div>
    <div class="col-12">
        <button class="btn btn-primary">Crear</button>
    </div>
</form>
{% endif %}

{% if section == "misas" %}
<h3>Misas</h3>
<table class="table table-striped">
    <tr><th>Fecha</th><th>Hora</th><th>AM/PM</th><th>Acciones</th></tr>
    {% for m in misas %}
    <tr>
        <td>{{ m.fecha }}</td>
        <td>{{ m.hora }}</td>
        <td>{{ m.ampm }}</td>
        <td>
            <a href="/admin/misas/delete/{{ m.id }}" 
               class="btn btn-sm btn-danger"
               onclick="return confirm('¿Eliminar misa?')">Eliminar</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% if section == "crear_misa" %}
<h3>Crear Misa</h3>
<form action="/admin/misas/create" method="post" class="row g-3">
    <div class="col-md-4">
        <label>Fecha</label>
        <input type="date" name="fecha" class="form-control" required>
    </div>
    <div class="col-md-4">
        <label>Hora (HHMM)</label>
        <input id="hora_input" name="hora" class="form-control" placeholder="0700" required>
    </div>
    <div class="col-md-4">
        <label>AM/PM</label>
        <select name="ampm" class="form-select">
            <option>AM</option>
            <option>PM</option>
        </select>
    </div>
    <div class="col-12">
        <button class="btn btn-primary">Crear misa</button>
    </div>
</form>
{% endif %}

{% if section == "categorias" %}
<h3>Categorías</h3>
<table class="table table-striped">
    <tr>
        <th>Nombre</th><th>Descripción</th><th>Texto adicional</th><th>Acciones</th>
    </tr>
    {% for c in categorias %}
    <tr>
        <td>{{ c.nombre }}</td>
        <td>{{ c.descripcion }}</td>
        <td>{{ c.texto_adicional }}</td>
        <td>
            <a href="/admin/categorias/delete/{{ c.id }}" class="btn btn-sm btn-danger"
               onclick="return confirm('¿Eliminar categoría?')">Eliminar</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% if section == "crear_categoria" %}
<h3>Crear Categoría</h3>
<form action="/admin/categorias/create" method="post" class="row g-3">
    <div class="col-md-6">
        <label>Nombre</label>
        <input name="nombre" class="form-control" oninput="soloMayusculasComasPuntos(this)" required>
    </div>
    <div class="col-md-6">
        <label>Descripción</label>
        <input name="descripcion" class="form-control" oninput="soloMayusculasComasPuntos(this)" required>
    </div>
    <div class="col-12">
        <label>Texto adicional (PDF)</label>
        <textarea name="texto_adicional" class="form-control" oninput="soloMayusculasComasPuntos(this)"></textarea>
    </div>
    <div class="col-12">
        <button class="btn btn-primary">Crear categoría</button>
    </div>
</form>
{% endif %}

{% if section == "frases" %}
<h3>Frases Base</h3>
<ul class="list-group">
    {% for f in frases %}
    <li class="list-group-item d-flex justify-content-between">
        {{ f.frase }}
        <a href="/admin/intencion_base/delete/{{ f.id }}" 
           class="btn btn-sm btn-danger">Eliminar</a>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if section == "crear_frase" %}
<h3>Crear Frase Base</h3>
<form action="/admin/intencion_base/create" method="post" class="row g-3">
    <div class="col-md-12">
        <label>Frase</label>
        <input name="frase" class="form-control" oninput="soloMayusculasComasPuntos(this)" required>
    </div>
    <div class="col-md-12">
        <button class="btn btn-primary">Crear frase</button>
    </div>
</form>
{% endif %}

{% if section == "config" %}
<h3>Configuración Global</h3>
<form action="/admin/settings/pdf_text" method="post">
    <label>Texto global para PDF</label>
    <textarea name="pdf_texto_global" class="form-control mb-2" oninput="soloMayusculasComasPuntos(this)">{{ texto_global }}</textarea>
    <button class="btn btn-primary">Guardar cambios</button>
</form>
{% endif %}

{% if section == "export" %}
<h3>Exportar CSV</h3>
<form action="/admin/export_csv" method="post" class="row g-3">
    <div class="col-md-6">
        <label>Desde</label>
        <input type="date" name="desde" class="form-control" required>
    </div>
    <div class="col-md-6">
        <label>Hasta</label>
        <input type="date" name="hasta" class="form-control" required>
    </div>
    <div class="col-12">
        <button class="btn btn-outline-primary">Exportar</button>
    </div>
</form>
{% endif %}

{% if section == "delete" %}
<h3>Eliminar Intenciones</h3>
<p>Última eliminación registrada: <strong>{{ last_deletion }}</strong></p>
<form action="/admin/delete_range" method="post" 
      onsubmit="return confirm('¿Seguro que desea eliminar este rango?')"
      class="row g-3">
    <div class="col-md-12">
        <label>Eliminar hasta la fecha</label>
        <input type="date" name="hasta" class="form-control" required>
    </div>
    <div class="col-12">
        <button class="btn btn-danger">Eliminar</button>
    </div>
</form>
{% endif %}

{% endblock %}
