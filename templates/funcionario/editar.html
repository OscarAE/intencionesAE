{% extends "base.html" %}
{% block content %}
<h3>Editar Intención</h3>
<form method="post">
  <div class="mb-2">
    <label>Categoría</label>
    <select class="form-select" name="categoria_id" id="categoria_sel">
      {% for c in categorias %}
        <option value="{{ c.id }}" {% if c.id==row.categoria_id %}selected{% endif %}>
          {{ c.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- CAMPO OFRECE -->
  <div class="mb-2">
    <label id="label_ofrece">Ofrece (nombre)</label>
    <input class="form-control" name="ofrece" value="{{ row.ofrece }}" 
           oninput="soloMayusculasComasPuntos(this)" required>
  </div>

  <!-- INTENCION BASE -->
  <div class="mb-2" id="int_base_group">
    <label>Intención base</label>
    <select class="form-select" name="int_base_id" id="int_base_sel">
      {% for b in int_b %}
      <option value="{{ b.id }}" {% if b.id==row.intencion_base_id %}selected{% endif %}>
        {{ b.frase }}
      </option>
      {% endfor %}
    </select>
  </div>

  <!-- PETICIONES -->
  <div class="mb-2" id="peticiones_group">
    <label>Peticiones (máx 250)</label>
    <textarea class="form-control" name="peticiones" maxlength="250" 
              oninput="soloMayusculasComasPuntos(this)">{{ row.peticiones }}</textarea>
  </div>

  <button class="btn btn-primary">Guardar cambios</button>
  <a class="btn btn-secondary" href="/funcionario">Volver</a>
</form>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const categoriaSelect = document.getElementById("categoria_sel");
    const labelOfrece = document.getElementById("label_ofrece");

    const divIntBase = document.getElementById("int_base_group");
    const divPeticiones = document.getElementById("peticiones_group");

    const intBaseSelect = document.getElementById("int_base_sel");
    const peticionesTextarea = document.querySelector("textarea[name='peticiones']");

    function actualizarFormulario() {

        let textoCategoria = categoriaSelect.options[categoriaSelect.selectedIndex].text.toUpperCase();

        // ===== DIFUNTOS =====
        if (textoCategoria.includes("DIFUN")) {

            labelOfrece.textContent = "POR EL ALIVIO Y ETERNO DESCANSO DE:";
            divIntBase.style.display = "none";
            divPeticiones.style.display = "none";

            intBaseSelect.value = "";
            peticionesTextarea.value = "";

            intBaseSelect.removeAttribute("required");
            peticionesTextarea.removeAttribute("required");
            return;
        }

        // ===== SALUD =====
        if (textoCategoria.includes("SALUD")) {

            labelOfrece.textContent = "POR LA SALUD FÍSICA Y ESPIRITUAL DE:";
            divIntBase.style.display = "none";
            divPeticiones.style.display = "none";

            intBaseSelect.value = "";
            peticionesTextarea.value = "";

            intBaseSelect.removeAttribute("required");
            peticionesTextarea.removeAttribute("required");
            return;
        }

        // ===== OTRAS CATEGORÍAS =====
        labelOfrece.textContent = "Ofrece (nombre)";

        divIntBase.style.display = "block";
        divPeticiones.style.display = "block";

        intBaseSelect.setAttribute("required", "required");
        peticionesTextarea.setAttribute("required", "required");
    }

    actualizarFormulario();
    categoriaSelect.addEventListener("change", actualizarFormulario);

});
</script>
{% endblock %}
