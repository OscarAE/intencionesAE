{% extends "base.html" %}
{% block content %}
<h3>Editar Intención</h3>
<form method="post">
  <div class="mb-2">
    <label>Categoría</label>
    <select class="form-select" name="categoria_id" id="categoria_sel">
      {% for c in categorias %}
        <option value="{{ c.id }}" {% if c.id==row.categoria_id %}selected{% endif %}>
          {{ c.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- CAMPO OFRECE -->
  <div class="mb-2">
    <label id="label_ofrece">Ofrece</label>
    <input class="form-control" name="ofrece" value="{{ row.ofrece }}" oninput="soloMayusculasComasPuntos(this)" required>
  </div>

  <!-- INTENCION BASE -->
  <div class="mb-2" id="int_base_group">
    <label>Intención base</label>
    <select class="form-select" name="int_base_id" id="int_base_sel">
      {% for b in int_b %}
      <option value="{{ b.id }}" {% if b.id==row.intencion_base_id %}selected{% endif %}>
        {{ b.frase }}
      </option>
      {% endfor %}
    </select>
  </div>

  <!-- PETICIONES -->
  <div class="mb-2" id="peticiones_group">
    <label>Peticiones (máx 250)</label>
    <textarea class="form-control" name="peticiones" maxlength="250" oninput="soloMayusculasComasPuntos(this)">{{ row.peticiones }}</textarea>
  </div>

  <button class="btn btn-primary">Guardar cambios</button>
  <a class="btn btn-secondary" href="/funcionario">Volver</a>
</form>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const categoriaSelect = document.querySelector("select[name='categoria_id']");
    const labelOfrece = document.querySelector("label[for='input_ofrece']") 
                         || document.querySelector("label:contains('Ofrece')") 
                         || document.querySelectorAll("label")[1];

    const divIntBase = document.querySelector("select[name='int_base_id']").closest(".mb-2");
    const divPeticiones = document.querySelector("textarea[name='peticiones']").closest(".mb-2");

    const intBaseSelect = document.querySelector("select[name='int_base_id']");
    const peticionesTextarea = document.querySelector("textarea[name='peticiones']");

    function actualizarFormulario() {
        if (!categoriaSelect) return;

        let textoCategoria = categoriaSelect.options[categoriaSelect.selectedIndex].text.toUpperCase();

        // ========= DIFUNTOS =========
        if (textoCategoria.includes("DIFUN")) {

            labelOfrece.textContent = "Por el alma y eterno descanso de:";

            divIntBase.style.display = "none";
            divPeticiones.style.display = "none";

            intBaseSelect.value = "";
            peticionesTextarea.value = "";

            intBaseSelect.removeAttribute("required");
            peticionesTextarea.removeAttribute("required");

        // ========= SALUD =========
        } else if (textoCategoria.includes("SALUD")) {

            labelOfrece.textContent = "Por la salud física y espiritual de:";

            divIntBase.style.display = "block";
            divPeticiones.style.display = "block";

            intBaseSelect.setAttribute("required", "required");
            peticionesTextarea.setAttribute("required", "required");

        // ========= OTRAS =========
        } else {
            labelOfrece.textContent = "Ofrece";

            divIntBase.style.display = "block";
            divPeticiones.style.display = "block";

            intBaseSelect.setAttribute("required", "required");
            peticionesTextarea.setAttribute("required", "required");
        }
    }

    actualizarFormulario();
    categoriaSelect.addEventListener("change", actualizarFormulario);

});
</script>
{% endblock %}
